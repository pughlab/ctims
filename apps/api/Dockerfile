FROM node:16.14-slim AS base

RUN apt-get update && \
    apt-get install -y \
    python3 \
    make \
    openssl libssl-dev \
    g++ && \
    rm -rf /var/lib/apt/lists/*

RUN yarn global add nx

WORKDIR /usr/src/app

COPY package.json yarn.lock ./

COPY ./ /usr/src/app/

RUN yarn install --loglevel=error

RUN yarn generate:build

# using node:18 here due to prisma issue of missing openssl lib: https://github.com/prisma/prisma/issues/15598
FROM node:18.14-slim AS production

## Copy built files from the build stage
WORKDIR /usr/src/app
COPY --from=base /usr/src/app/dist ./dist
COPY --from=base /usr/src/app/apps/api/prisma ./apps/api/prisma
COPY --from=base /usr/src/app/node_modules ./node_modules
COPY --from=base /usr/src/app/package.json ./package.json

ARG KEYCLOAK_REALM
ARG KEYCLOAK_URL
ARG KEYCLOAK_CLIENT_ID
ARG KEYCLOAK_CLIENT_SECRET
ARG KEYCLOAK_ADMIN_CLIENT_ID
ARG KEYCLOAK_ADMIN_CLIENT_SECRET
ARG KEYCLOAK_TOKEN_ENDPOINT
ARG KEYCLOAK_CLIENT_UUID
ARG PRISMA_FIELD_ENCRYPTION_KEY
ARG MM_API_URL
ARG CTIMS_ENV
ARG MM_API_TOKEN
ARG CTIMS_API_VERSION
ARG CTIMS_API_KEY
ARG MATCHMINER_SEND_QUEUE
ARG MATCHMINER_RECEIVE_QUEUE
ARG RABBITMQ_URL
ARG RABBITMQ_PORT
ARG MAIL_HOST
ARG MAIL_USERNAME
ARG MAIL_PASSWORD
ARG NEXT_PUBLIC_TRIAL_LOCK_PING_TIME_MS
ARG NEXT_TRIAL_LOCK_CLEAR_TIME_MS
ARG CTIMS_SUPPORT_EMAIL
ARG CTIMS_URL

ENV KEYCLOAK_REALM=$KEYCLOAK_REALM
ENV KEYCLOAK_URL=$KEYCLOAK_URL
ENV KEYCLOAK_CLIENT_ID=$KEYCLOAK_CLIENT_ID
ENV KEYCLOAK_CLIENT_SECRET=$KEYCLOAK_CLIENT_SECRET
ENV KEYCLOAK_ADMIN_CLIENT_ID=$KEYCLOAK_ADMIN_CLIENT_ID
ENV KEYCLOAK_ADMIN_CLIENT_SECRET=$KEYCLOAK_ADMIN_CLIENT_SECRET
ENV KEYCLOAK_TOKEN_ENDPOINT=$KEYCLOAK_TOKEN_ENDPOINT
ENV KEYCLOAK_CLIENT_UUID=$KEYCLOAK_CLIENT_UUID
ENV PRISMA_FIELD_ENCRYPTION_KEY=$PRISMA_FIELD_ENCRYPTION_KEY
ENV MM_API_URL=$MM_API_URL
ENV CTIMS_ENV=$CTIMS_ENV
ENV MM_API_TOKEN=$MM_API_TOKEN
ENV CTIMS_API_VERSION=$CTIMS_API_VERSION
ENV CTIMS_API_KEY=$CTIMS_API_KEY
ENV MATCHMINER_SEND_QUEUE=$MATCHMINER_SEND_QUEUE
ENV MATCHMINER_RECEIVE_QUEUE=$MATCHMINER_RECEIVE_QUEUE
ENV RABBITMQ_URL=$RABBITMQ_URL
ENV RABBITMQ_PORT=$RABBITMQ_PORT
ENV MAIL_HOST=$MAIL_HOST
ENV MAIL_USERNAME=$MAIL_USERNAME
ENV MAIL_PASSWORD=$MAIL_PASSWORD
ENV NEXT_PUBLIC_TRIAL_LOCK_PING_TIME_MS=$NEXT_PUBLIC_TRIAL_LOCK_PING_TIME_MS
ENV NEXT_TRIAL_LOCK_CLEAR_TIME_MS=$NEXT_TRIAL_LOCK_CLEAR_TIME_MS
ENV CTIMS_SUPPORT_EMAIL=$CTIMS_SUPPORT_EMAIL
ENV CTIMS_URL=$CTIMS_URL

CMD ["yarn", "start:prod"]
